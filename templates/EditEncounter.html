{% extends "DeathWishBase.html" %}

{% block title %}
    {% if encounter.name != "blank" %}
        {{ encounter.name }}
    {% else %}
        New Encounter
    {% endif %}
{% endblock %}

{% block content %}
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='encounter.css') }}">
</head>
<body>
    <form method="POST" id="save_encounter_form">
        <h3>Encounter Name</h3>
        <input type="hidden" name="action" value="save_encounter_form">
        <!-- autopopulate if encounter already exists -->
        {% if encounter.name == "blank" %}
            <label for="encounterName">Encounter Name:</label>
            <input type="text" name="encounterName" placeholder="encounter name">
        {% else %}
            <label for="encounterName">Encounter Name:</label>
            <input type="text" name="encounterName" value="{{ encounter.name }}" placeholder="encounter name">
        {% endif %}
    </form>
    <button type="submit" form="save_encounter_form">Save Encounter</button>
    <br>
    <br>
    <form method="POST" id="delete_encounter_form">
        <input type="hidden" name="action" value="delete_encounter_form">
        <button type="submit" name="delete_encounter">Delete Encounter</button>
    </form>
    <br>
    <br>
    <div id="object-palette">
        {% for obj_type in object_types %}
        <div class="palette-object" data-type="{{ obj_type }}" draggable="true">{{ obj_type }}</div>
        {% endfor %}
    </div>
    <div id="grid-container">
        {% for row in range(10) %}
        <div class="grid-row">
            {% for col in range(10) %}
            <div class="grid-cell" data-row="{{ row }}" data-col="{{ col }}"></div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    <form method="POST">
        <input type="hidden" id="grid_data" name="grid_data">
        <button type="submit">Save Grid</button>
    </form>
    <script>
        const gridContainer = document.getElementById('grid-container');
        const objectPalette = document.getElementById('object-palette');
        const gridDataInput = document.getElementById('grid_data');
        const cellSize = 50;
        let objectsOnGrid = [];
        let nextObjectId = 0;

        objectPalette.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', e.target.dataset.type);
        });

        gridContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        gridContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            const objectType = e.dataTransfer.getData('text/plain');
            createDraggableObject(objectType, e.clientX, e.clientY);
        });

        function createDraggableObject(objectType, x, y) {
            const gridRect = gridContainer.getBoundingClientRect();
            const obj = document.createElement('div');
            obj.id = `draggable-object-${nextObjectId++}`;
            obj.classList.add('draggable-object', objectType);
            obj.draggable = true;
            obj.style.left = (x - gridRect.left -50) + 'px';
            obj.style.top = (y - gridRect.top - 50) + 'px';
            gridContainer.appendChild(obj);
            objectsOnGrid.push(obj);
            makeDraggable(obj);
        }

        function makeDraggable(obj) {
            let initialX;
            let initialY;
            let xOffset = parseInt(obj.style.left) || 0;
            let yOffset = parseInt(obj.style.top) || 0;

            obj.addEventListener('dragstart', (e) => {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
            });

            obj.addEventListener('drag', (e) => {
                if (e.clientX && e.clientY) {
                    xOffset = e.clientX - initialX;
                    yOffset = e.clientY - initialY;
                    obj.style.left = xOffset + 'px';
                    obj.style.top = yOffset + 'px';
                }
            });
            obj.addEventListener('dragend', updateGridData);
        }

        function updateGridData() {
            const grid = [];
            for (let row = 0; row < 10; row++) {
                grid.push([]);
                for (let col = 0; col < 10; col++) {
                    grid[row].push({ objects: [] });
                }
            }

            objectsOnGrid.forEach(obj => {
                const objRect = obj.getBoundingClientRect();
                const gridRect = gridContainer.getBoundingClientRect();
                const objLeft = objRect.left - gridRect.left;
                const objTop = objRect.top - gridRect.top;
                const objRight = objLeft + objRect.width;
                const objBottom = objTop + objRect.height;
                const objName = obj.classList[1]; // Get the object type

                for (let row = 0; row < 10; row++) {
                    for (let col = 0; col < 10; col++) {
                        const cellLeft = col * cellSize;
                        const cellTop = row * cellSize;
                        const cellRight = cellLeft + cellSize;
                        const cellBottom = cellTop + cellSize;

                        if (!(objRight < cellLeft || objLeft > cellRight || objBottom < cellTop || objTop > cellBottom)) {
                            grid[row][col].objects.push(objName);
                        }
                    }
                }
            });

            gridDataInput.value = JSON.stringify(grid);
        }

        gridContainer.addEventListener('drop', updateGridData);
    </script>
</body>
{% endblock %}